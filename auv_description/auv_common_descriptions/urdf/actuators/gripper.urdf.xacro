<?xml version="1.0"?>
<!-- AUV Parallel Gripper Description
     Adapted from UUV Simulator Oberon4 gripper
     This gripper will be mounted underneath the AUV facing downwards
-->
<robot xmlns:xacro="http://www.ros.org/wiki/xacro">
  <!-- Gripper Constants -->
  <xacro:property name="PI" value="3.1415926535897931"/>

  <!-- Physical properties based on oberon4 measurements -->
  <xacro:property name="gripper_base_volume" value="0.000637"/>
  <xacro:property name="gripper_base_mass" value="0.5"/>
  <xacro:property name="gripper_base_x" value="0.085493"/>
  <xacro:property name="gripper_base_y" value="0.1143"/>
  <xacro:property name="gripper_base_z" value="0.145416"/>
  <xacro:property name="gripper_base_center_of_mass" value="0.026082 -0.000011 -0.00012"/>

  <xacro:property name="jaw_volume" value="0.000797"/>
  <xacro:property name="jaw_mass" value="0.3"/>
  <xacro:property name="jaw_x" value="0.191011"/>
  <xacro:property name="jaw_y" value="0.108069"/>
  <xacro:property name="jaw_z" value="0.091102"/>
  <xacro:property name="jaw_center_of_mass" value="0.052693 0.02887 -0.00805"/>

  <!-- Gripper control parameters -->
  <xacro:property name="gripper_effort" value="50"/>
  <xacro:property name="gripper_velocity" value="0.1"/>
  <xacro:property name="gripper_damping" value="10"/>
  <xacro:property name="gripper_friction" value="5"/>

  <!-- Transmission Macro -->
  <xacro:macro name="gripper_transmission" params="joint">
    <transmission name="${joint}_trans">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="${joint}">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
      </joint>
      <actuator name="${joint}_motor">
        <hardwareInterface>hardware_interface/EffortJointInterface</hardwareInterface>
        <mechanicalReduction>1</mechanicalReduction>
      </actuator>
    </transmission>
  </xacro:macro>

  <!-- Main Gripper Macro -->
  <xacro:macro name="gripper" params="name parent position orientation namespace">
    <!-- Mount Link - connects gripper to the robot -->
    <link name="${name}_mount">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <mass value="0.05"/>
        <inertia ixx="0.0001" ixy="0.0" ixz="0.0" iyy="0.0001" iyz="0.0" izz="0.0001"/>
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <cylinder radius="0.01" length="0.02"/>
        </geometry>
        <material name="dark_grey">
          <color rgba="0.3 0.3 0.3 1.0"/>
        </material>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <cylinder radius="0.01" length="0.02"/>
        </geometry>
      </collision>
    </link>

    <!-- Mount Joint - fixed joint to attach gripper to robot -->
    <joint name="${name}_mount_joint" type="fixed">
      <parent link="${parent}"/>
      <child link="${name}_mount"/>
      <origin xyz="${position}" rpy="${orientation}"/>
    </joint>

    <!-- Gripper Base Link -->
    <link name="${name}_base">
      <inertial>
        <origin xyz="${gripper_base_center_of_mass}" rpy="0 0 0"/>
        <mass value="${gripper_base_mass}"/>
        <inertia
          ixx="${gripper_base_mass / 12.0 * (gripper_base_y*gripper_base_y + gripper_base_z*gripper_base_z)}"
          ixy="0.0"
          ixz="0.0"
          iyy="${gripper_base_mass / 12.0 * (gripper_base_x*gripper_base_x + gripper_base_z*gripper_base_z)}"
          iyz="0.0"
          izz="${gripper_base_mass / 12.0 * (gripper_base_x*gripper_base_x + gripper_base_y*gripper_base_y)}"
        />
      </inertial>

      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://auv_common_descriptions/meshes/gripper/GripperBase.dae" scale="1 1 1"/>
        </geometry>
      </visual>

      <collision>
        <origin xyz="${gripper_base_center_of_mass}" rpy="0 0 0"/>
        <geometry>
          <box size="${gripper_base_x} ${gripper_base_y} ${gripper_base_z}"/>
        </geometry>
      </collision>
    </link>

    <!-- Base Joint - connects mount to gripper base -->
    <joint name="${name}_base_joint" type="fixed">
      <parent link="${name}_mount"/>
      <child link="${name}_base"/>
      <origin xyz="0 0 0" rpy="0 0 0"/>
    </joint>

    <!-- Left Jaw Link -->
    <link name="${name}_left_jaw">
      <inertial>
        <origin xyz="${jaw_center_of_mass}" rpy="0 0 0"/>
        <mass value="${jaw_mass}"/>
        <inertia
          ixx="${jaw_mass / 12.0 * (jaw_y*jaw_y + jaw_z*jaw_z)}"
          ixy="0.0"
          ixz="0.0"
          iyy="${jaw_mass / 12.0 * (jaw_x*jaw_x + jaw_z*jaw_z)}"
          iyz="0.0"
          izz="${jaw_mass / 12.0 * (jaw_x*jaw_x + jaw_y*jaw_y)}"
        />
      </inertial>

      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://auv_common_descriptions/meshes/gripper/Jaw.dae" scale="1 1 1"/>
        </geometry>
      </visual>

      <collision>
        <origin xyz="0.08 0.035 -0.002" rpy="0 0 0"/>
        <geometry>
          <box size="0.12 0.02 0.025"/>
        </geometry>
      </collision>
      <collision>
        <origin xyz="0.145 0.055 -0.002" rpy="0 0 0.7"/>
        <geometry>
          <box size="0.07 0.015 0.025"/>
        </geometry>
      </collision>
      <collision>
        <origin xyz="0.08 0.035 -0.07" rpy="0 0 0"/>
        <geometry>
          <box size="0.12 0.02 0.025"/>
        </geometry>
      </collision>
      <collision>
        <origin xyz="0.145 0.055 -0.07" rpy="0 0 0.7"/>
        <geometry>
          <box size="0.07 0.015 0.025"/>
        </geometry>
      </collision>
    </link>

    <!-- Right Jaw Link -->
    <link name="${name}_right_jaw">
      <inertial>
        <origin xyz="${jaw_center_of_mass}" rpy="0 0 0"/>
        <mass value="${jaw_mass}"/>
        <inertia
          ixx="${jaw_mass / 12.0 * (jaw_y*jaw_y + jaw_z*jaw_z)}"
          ixy="0.0"
          ixz="0.0"
          iyy="${jaw_mass / 12.0 * (jaw_x*jaw_x + jaw_z*jaw_z)}"
          iyz="0.0"
          izz="${jaw_mass / 12.0 * (jaw_x*jaw_x + jaw_y*jaw_y)}"
        />
      </inertial>

      <visual>
        <origin xyz="0 0 0" rpy="0 0 0"/>
        <geometry>
          <mesh filename="package://auv_common_descriptions/meshes/gripper/Jaw.dae" scale="1 1 1"/>
        </geometry>
      </visual>

      <collision>
        <origin xyz="0.08 0.035 -0.002" rpy="0 0 0"/>
        <geometry>
          <box size="0.12 0.02 0.025"/>
        </geometry>
      </collision>
      <collision>
        <origin xyz="0.145 0.055 -0.002" rpy="0 0 0.7"/>
        <geometry>
          <box size="0.07 0.015 0.025"/>
        </geometry>
      </collision>
      <collision>
        <origin xyz="0.08 0.035 -0.07" rpy="0 0 0"/>
        <geometry>
          <box size="0.12 0.02 0.025"/>
        </geometry>
      </collision>
      <collision>
        <origin xyz="0.145 0.055 -0.07" rpy="0 0 0.7"/>
        <geometry>
          <box size="0.07 0.015 0.025"/>
        </geometry>
      </collision>
    </link>

    <!-- Left Jaw Joint -->
    <joint name="${name}_left_jaw_joint" type="revolute">
      <parent link="${name}_base"/>
      <child link="${name}_left_jaw"/>
      <origin xyz="0.0444253 0.021926 0.0487509" rpy="${-0.5*PI} 0 0"/>
      <dynamics damping="${gripper_damping}" friction="${gripper_friction}"/>
      <axis xyz="0 0 1"/>
      <limit lower="${-0.5*PI}" upper="0" velocity="${gripper_velocity}" effort="${gripper_effort}"/>
    </joint>

    <!-- Right Jaw Joint (mimic left jaw) -->
    <joint name="${name}_right_jaw_joint" type="revolute">
      <parent link="${name}_base"/>
      <child link="${name}_right_jaw"/>
      <origin xyz="0.0444253 -0.021926 -0.0487509" rpy="${0.5*PI} 0 0"/>
      <dynamics damping="${gripper_damping}" friction="${gripper_friction}"/>
      <axis xyz="0 0 1"/>
      <limit lower="${-0.5*PI}" upper="0" velocity="${gripper_velocity}" effort="${gripper_effort}"/>
      <mimic joint="${name}_left_jaw_joint" multiplier="1.0" offset="0"/>
    </joint>

    <!-- Transmissions for control -->
    <xacro:gripper_transmission joint="${name}_left_jaw_joint"/>
    <xacro:gripper_transmission joint="${name}_right_jaw_joint"/>

    <!-- Gazebo-specific configurations -->
    <gazebo reference="${name}_base">
      <material>Gazebo/DarkGrey</material>
      <mu1>0.8</mu1>
      <mu2>0.8</mu2>
      <minDepth>0.001</minDepth>
    </gazebo>

    <gazebo reference="${name}_left_jaw">
      <material>Gazebo/Grey</material>
      <mu1>1.0</mu1>
      <mu2>1.0</mu2>
      <minDepth>0.001</minDepth>
      <kp>1000000.0</kp>
      <kd>100.0</kd>
    </gazebo>

    <gazebo reference="${name}_right_jaw">
      <material>Gazebo/Grey</material>
      <mu1>1.0</mu1>
      <mu2>1.0</mu2>
      <minDepth>0.001</minDepth>
      <kp>1000000.0</kp>
      <kd>100.0</kd>
    </gazebo>

    <gazebo reference="${name}_mount">
      <material>Gazebo/Black</material>
    </gazebo>

    <!-- Gazebo ROS Control Plugin for the gripper -->
    <gazebo>
      <plugin name="${name}_gazebo_ros_control" filename="libgazebo_ros_control.so">
        <robotNamespace>${namespace}</robotNamespace>
        <robotSimType>gazebo_ros_control/DefaultRobotHWSim</robotSimType>
      </plugin>
    </gazebo>
  </xacro:macro>
</robot>
