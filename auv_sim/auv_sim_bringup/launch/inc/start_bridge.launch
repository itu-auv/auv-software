<?xml version="1.0"?>
<launch>
  <arg name="namespace" default="taluy" />
  <arg name="control_rate" default="20" />
  <arg name="sim" default="true" />
  <arg name="use_gui" default="true" />

  <rosparam command="load" file="$(find auv_sim_description)/config/environment.yaml" />

  <group ns="$(arg namespace)">
    <node name="auv_sim_bridge" pkg="auv_sim_bridge" type="simulation_mock_node" output="screen">
      <rosparam command="load" file="$(find auv_localization)/config/imu_calibration_data.yaml"
        ns="imu" />

      <!-- outputs -->
      <remap from="depth" to="sensors/external_pressure_sensor/depth" />
      <remap from="power" to="mainboard/power_sensor/power" />
      <remap from="altitude" to="sensors/dvl/altitude" />
      <remap from="velocity_raw" to="sensors/dvl/velocity_raw" />
      <remap from="is_valid" to="sensors/dvl/is_valid" />
      <remap from="imu_drifted" to="sensors/imu/data" />

      <!-- inputs -->
      <remap from="drive_pulse" to="board/drive_pulse" />
      <remap from="pressure" to="sim/pressure" />
      <remap from="dvl" to="sim/dvl" />
      <remap from="imu_raw" to="sim/imu" />

      <!-- params -->
      <param name="rate" value="$(arg control_rate)" />
    </node>

    <!-- Ball Dropper Service Node -->
    <node name="drop_ball_server" pkg="auv_sim_bridge" type="sim_bin_mock.py" output="screen">
      <remap from="actuators/ball_dropper/drop" to="actuators/ball_dropper/drop" />
    </node>
    <!-- Torpedo Launcher Service Node -->
    <node name="launch_torpedo_server" pkg="auv_sim_bridge" type="sim_torpedo_mock.py" output="screen">
      <remap from="actuators/torpedo_1/launch" to="actuators/torpedo_1/launch" />
      <remap from="actuators/torpedo_2/launch" to="actuators/torpedo_2/launch" />
    </node>

    <!-- Gripper Service Node -->
    <node name="gripper_service" pkg="auv_sim_bridge" type="sim_gripper_service.py" output="screen">
      <param name="model_name" value="$(arg namespace)" />
      <param name="robot_description_param" value="/$(arg namespace)/robot_description" />
      <param name="left_joint" value="$(arg namespace)/finger_left_joint" />
      <param name="right_joint" value="$(arg namespace)/finger_right_joint" />
      <!-- Neutral/Normal: parallel fingers (0.0 rad), Open: opened outward (+0.25 rad), Close: closed inward (-0.15 rad) -->
      <param name="open_angle" value="0.25" />
      <param name="close_angle" value="-0.15" />
      <param name="neutral_angle" value="0.0" />
      <!-- Behavior params -->
      <param name="mirror_right" value="false" />
      <param name="move_duration" value="1.5" />
      <param name="move_steps" value="40" />
      <!-- Effort control - BALANCED: Strong but non-vibrating grip -->
      <param name="use_effort_control" value="true" />
      <param name="kp_effort" value="45.0" />
      <param name="max_effort" value="20.0" />
      <param name="hold_effort" value="7.0" />
      <remap from="actuators/gripper/set" to="actuators/gripper/set" />
      <remap from="actuators/gripper/open" to="actuators/gripper/open" />
      <remap from="actuators/gripper/close" to="actuators/gripper/close" />
      <remap from="actuators/gripper/neutral" to="actuators/gripper/neutral" />
    </node>
  </group>

  <include file="$(find auv_bringup)/launch/start_navigation.launch">
    <arg name="namespace" value="$(arg namespace)" />
    <arg name="control_rate" value="$(arg control_rate)" />
    <arg name="sim" value="$(arg sim)" />
    <arg name="use_gui" value="$(arg use_gui)" />
    <arg name="start_state_publisher" value="false" />
    <arg name="config_file" value="$(find auv_sim_bridge)/config/control_config.yaml"/>
  </include>

  <!-- launch parameter server -->
  <include file="$(find auv_bringup)/launch/param_server.launch">
    <arg name="namespace" value="$(arg namespace)" />
  </include>

</launch>
